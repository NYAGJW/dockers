#!/bin/sh

# Run a shell in the dumpling Docker container as the host user
# with some features accessible from within the container:
#
#   * home directories
#   * users and groups
#   * ssh private key identities (e.g., for git)

set -eu

if [ -z "${SSH_AUTH_SOCK-}" ]; then
  eval "$(ssh-agent)" > /dev/null
fi

# Update Docker image unless running in Travis CI.
# Also, since a --quiet option does not exist, hide the output
# that is otherwise displayed when the local copy is up-to-date.
if [ "${CI-}" != true ]; then
  docker pull nyag/dumpling | \
  grep -v -e '^Using default tag' -e '^Trying to pull' \
  -e '^latest' -e '^Digest' && true
fi

user="${SUDO_USER-$USER}"
name="${user}-dumpling"
if [ -n "$(docker ps -q -f "name=${name}")" ]; then
    exec docker exec -it -u "$user" "$name" /bin/bash
else
    exec docker run -it --rm --name "$name" \
      --network host --cap-add SYS_ADMIN --cap-add DAC_READ_SEARCH \
      -v /home:/home \
      -v /etc/group:/etc/group.host:ro \
      -v /etc/localtime:/etc/localtime:ro \
      -v /etc/passwd:/etc/passwd.host:ro \
      -v /srv/cifs:/srv/cifs:ro \
      -v "${SSH_AUTH_SOCK}":/tmp/ssh \
      -e SSH_AUTH_SOCK=/tmp/ssh \
      -e "USER=${user}" \
      -e PORT1 -e PORT2 -e PORT3 -e PORT4 -e BOLTPORT -e NEOPORT \
      nyag/dumpling "$@"
fi
